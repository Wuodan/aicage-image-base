name: Build All Base Images

"on":
  push:
    tags:
      - "*"
  schedule:
    - cron: "0 2 * * 2"
  workflow_dispatch: {}

concurrency:
  group: build-all
  cancel-in-progress: true

jobs:

  latest-release-tag:
    runs-on: ubuntu-latest
    env:
      GIT_REF: ${{ github.ref }}
    outputs:
      GIT_REF: ${{ steps.config.outputs.GIT_REF }}
    steps:
      - name: "Config: Get tag of latest release"
        id: config
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            GIT_REF="$(
              curl \
                -fsSL \
                --retry 8 \
                --retry-all-errors \
                --retry-delay 2 \
                --max-time 300 \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/aicage/aicage-image/releases/latest \
              | jq -r '.tag_name' \
            )"
          fi
          if [[ -z "${GIT_REF}" ]]; then
            echo "Git tag is empty for latest release" >&2
            exit 1
          fi
          {
            echo "GIT_REF=${GIT_REF}"
          } >> "$GITHUB_OUTPUT"
          echo "Latest release tag: ${GIT_REF}"

  dispatch:
    name: Dispatch base builds for ${{ needs.latest-release-tag.outputs.GIT_REF }}
    runs-on: ubuntu-latest
    needs: latest-release-tag
    env:
      GH_TOKEN: ${{ github.token }}
      GIT_REF: ${{ needs.latest-release-tag.outputs.GIT_REF }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ needs.latest-release-tag.outputs.GIT_REF }}

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan .

      - name: "Test: Validate config and bases with schemas"
        run: |
          check-jsonschema \
            --schemafile doc/validation/config.schema.json \
            config.yaml
          check-jsonschema \
            --schemafile doc/validation/base.schema.json \
            bases/*/base.yaml

      - name: Dispatch per-base builds
        run: |
          set -euo pipefail
          for dir in bases/*; do
            BASE_ALIAS="$(basename "${dir}")"
            echo "Dispatching ${BASE_ALIAS} for ${GIT_REF}"
            gh workflow run build-image.yml --ref "${GIT_REF}" -f base="${BASE_ALIAS}"
          done
